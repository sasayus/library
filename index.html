<html lang="ko"><head>
    <meta charset="UTF-8">
    <title>ì‘ê°€ ì²œê° ì•„ì¹´ì´ë¸Œ Ver 30.2 (Final Immutable)</title>
    <style>
        :root { 
            --bg: #f5f5f7; --card: #ffffff; --sidebar: #ffffff;
            --text: #1d1d1f; --sub-text: #86868b; --accent: #1d1d1f; 
            --border: #e5e5e7; --shadow: 0 12px 40px rgba(0,0,0,0.08);
            --munpia: #d32f2f; --novel: #1976d2; --monster: #d70015;
            --rel-black: #1d1d1f; --rel-pink: #ff2d55; --rel-blue: #007aff; --rel-red: #ff3b30;
            --bookmark: #ffcc00; --star-gold: #ffcc00; --star-red: #ff3b30; --star-gray: #8e8e93;
            --timeline: #5856d6;
        }
        body.dark-mode { --bg: #1c1c1e; --card: #2c2c2e; --sidebar: #2c2c2e; --text: #f5f5f7; --border: #3a3a3c; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); display: flex; margin: 0; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        /* ë…ì ëª¨ë“œ ì²˜ë¦¬ */
        body.reader-mode .author-only, body.reader-mode .side-cat-6, body.reader-mode .side-cat-9 { display: none !important; }

        /* ì‚¬ì´ë“œë°” */
        nav { width: 300px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 25px 20px; overflow-y: auto; display: flex; flex-direction: column; z-index: 100; transition: 0.4s; }
        nav h2 { font-size: 1.1rem; border-bottom: 2px solid var(--text); padding-bottom: 15px; margin-bottom: 20px; text-align: center; font-weight: 800; cursor: pointer; }
        .theme-dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .novel-selector { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; font-weight: 700; background: var(--card); color: var(--text); border-left: 5px solid var(--accent); cursor: pointer; outline: none; }
        
        #sidebar-menu { flex: 1; overflow-y: auto; }
        .side-cat { font-size: 0.75rem; color: var(--accent); font-weight: 800; margin-top: 18px; border-bottom: 1px solid var(--border); padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .side-item { font-size: 0.85rem; padding: 10px 14px; cursor: pointer; border-radius: 8px; margin-top: 4px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .side-item.active { background: var(--accent); color: #fff; font-weight: 700; box-shadow: var(--shadow); }

        /* ë©”ì¸ ì˜ì—­ */
        main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 60px; align-items: center; position: relative; }
        .wiki-card { background: var(--card); padding: 60px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.03); width: 100%; max-width: 850px; min-height: 800px; border-top: 10px solid var(--accent); position: relative; transition: 0.4s; }
        .editor { line-height: 2.1; font-size: 1.15rem; outline: none; min-height: 350px; white-space: pre-wrap; padding: 25px; background: rgba(0,0,0,0.015); border-radius: 14px; border: 1px solid var(--border); margin-top: 25px; }

        /* íŠ¹ìˆ˜ UI ìš”ì†Œë“¤ */
        .diff-badge { padding: 10px 20px; border-radius: 12px; font-size: 0.9rem; font-weight: 900; display: inline-block; margin-bottom: 20px; cursor: pointer; }
        .diff-low { background: #e8f5e9; color: #2e7d32; } .diff-mid { background: #fff8e1; color: #f57f17; } .diff-high { background: #ffebee; color: #d32f2f; }
        
        .star-box { font-size: 1.5rem; letter-spacing: 5px; cursor: pointer; display: inline-block; }
        .star-gold { color: var(--star-gold) !important; } .star-red { color: var(--star-red) !important; } .star-gray { color: var(--star-gray) !important; }
        .star-rainbow { background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 2s infinite linear; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        .org-wrap { margin-left: 35px; border-left: 2px solid var(--border); padding-left: 20px; position: relative; margin-top: 12px; }
        .org-card { background: #fff; border: 1px solid var(--border); padding: 12px 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 8px; display: inline-flex; align-items: center; gap: 10px; min-width: 220px; }
        .org-name { font-weight: 800; cursor: pointer; font-size: 1rem; flex: 1; }

        .log-grid { display: grid; grid-template-columns: 120px 1fr 40px; gap: 8px; margin-bottom: 8px; background: #f9f9fb; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .log-input { border: 1px solid var(--border); padding: 8px; border-radius: 6px; font-size: 0.85rem; outline: none; background: #fff; }

        .side-bookmark { position: absolute; top: 50%; right: -15px; width: 22px; height: 90px; background: var(--bookmark); color: #5d4037; font-weight: 900; writing-mode: vertical-rl; text-align: center; line-height: 22px; border-radius: 6px 0 0 6px; cursor: pointer; z-index: 100; transition: 0.3s; transform: translateY(-50%); font-size: 0.75rem; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .side-memo-box { position: absolute; top: 50%; right: -320px; width: 280px; height: 400px; background: #fff9c4; border-radius: 15px; padding: 25px; box-shadow: 10px 10px 30px rgba(0,0,0,0.1); z-index: 99; transition: 0.3s; outline: none; overflow-y: auto; display: none; transform: translateY(-50%); border-left: 8px solid #fbc02d; font-family: 'Nanum Pen Script', cursive; }
        .side-memo-box.active { right: 5px; display: block; }
        .side-bookmark.active { right: 285px; border-radius: 0 6px 6px 0; }

        .author-tools { display: flex; flex-direction: column; gap: 6px; border-top: 1px solid var(--border); padding-top: 20px; margin-top: auto; }
        .btn-tool { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.75rem; text-align: center; transition: 0.2s; }
        .btn-tool:hover { transform: translateY(-2px); }

        .widget-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .widget-card { background: #fff; width: 90%; max-width: 1000px; height: 80%; border-radius: 24px; padding: 40px; box-shadow: var(--shadow); overflow-y: auto; }
    </style>
</head>
<body onload="init()">

<nav id="sidebar">
    <h2 onclick="location.reload()">CHUNGAK ARCHIVE 30.2</h2>
    <div class="theme-dots author-only">
        <div class="dot" style="background:#1d1d1f" onclick="setTheme('#1d1d1f')"></div>
        <div class="dot" style="background:#b71c1c" onclick="setTheme('#b71c1c')"></div>
        <div class="dot" style="background:#1a237e" onclick="setTheme('#1a237e')"></div>
        <div class="dot" style="background:#1b5e20" onclick="setTheme('#1b5e20')"></div>
    </div>
    <select id="novel-selector" class="novel-selector" onchange="switchNovel(this.value)"><option value="all">ì „ì²´ í”„ë¡œì íŠ¸ ë³´ê¸°</option><option value="ê¸°ì¡´ ì†Œì„¤">ê¸°ì¡´ ì†Œì„¤</option><option value="1" selected="">1</option></select>
    <div id="sidebar-menu" style="flex:1;"><div class="side-cat side-cat-0"><span>0. ì„¸ê³„ê´€</span><span class="author-only" onclick="addItem(0)">+</span></div><div class="side-item " onclick="goPage(4)">0. ì„¸ê³„ê´€ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-1"><span>1. ìºë¦­í„°</span><span class="author-only" onclick="addItem(1)">+</span></div><div class="side-item " onclick="goPage(5)">1. ìºë¦­í„° ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-2"><span>2. ëª¬ìŠ¤í„°(ê³µí†µ)</span><span class="author-only" onclick="addItem(2)">+</span></div><div class="side-item " onclick="goPage(3)">ìŠ¤ì¼ˆë ˆí†¤</div><div class="side-item " onclick="goPage(6)">2. ëª¬ìŠ¤í„°(ê³µí†µ) ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-3"><span>3. ì§œíˆ¬ë¦¬</span><span class="author-only" onclick="addItem(3)">+</span></div><div class="side-item " onclick="goPage(7)">3. ì§œíˆ¬ë¦¬ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-4"><span>4. ê°€ê³„ë„</span><span class="author-only" onclick="addItem(4)">+</span></div><div class="side-item " onclick="goPage(8)">4. ê°€ê³„ë„ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-5"><span>5. ì—°ëŒ€ê¸°</span><span class="author-only" onclick="addItem(5)">+</span></div><div class="side-item " onclick="goPage(9)">5. ì—°ëŒ€ê¸° ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-6"><span>6. ë³µì„  í˜„í™©</span><span class="author-only" onclick="addItem(6)">+</span></div><div class="side-item " onclick="goPage(10)">6. ë³µì„  í˜„í™© ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-7"><span>7. ìŠ¤í† ë¦¬ë³´ë“œ</span><span class="author-only" onclick="addItem(7)">+</span></div><div class="side-item " onclick="goPage(11)">7. ìŠ¤í† ë¦¬ë³´ë“œ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-8"><span>8. ë©€í‹°ë²„ìŠ¤</span><span class="author-only" onclick="addItem(8)">+</span></div><div class="side-item " onclick="goPage(12)">8. ë©€í‹°ë²„ìŠ¤ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-9"><span>9. ì—°ì¬ í˜„í™©</span><span class="author-only" onclick="addItem(9)">+</span></div><div class="side-item " onclick="goPage(13)">9. ì—°ì¬ í˜„í™© ì´ˆê¸° í•­ëª©</div></div>
    
    <div class="author-tools author-only">
        <button class="btn-tool" style="background:var(--accent); color:#fff;" onclick="copyFullSource()">ğŸ’¾ ì „ì²´ ì†ŒìŠ¤ ë³µì‚¬</button>
        <button class="btn-tool" style="color:var(--novel);" onclick="copyReaderLink()">ğŸ”— ë…ììš© ë§í¬ ë³µì‚¬</button>
        <button class="btn-tool" onclick="toggleNarrativeTable()">ğŸ“Š ì„œì‚¬ ëŒ€ì¡°í‘œ</button>
        <button class="btn-tool" style="color:var(--status-green);" onclick="createNewProject()">âœš ìƒˆ ì†Œì„¤ ì¶”ê°€</button>
        <button class="btn-tool" onclick="exportData()">ë°ì´í„° ë°±ì—…(JSON)</button>
        <button class="btn-tool" style="color:var(--rel-red);" onclick="deleteEntireProject()">âš ï¸ í”„ë¡œì íŠ¸ ì‚­ì œ</button>
    </div>
</nav>

<main>
    <div id="main-card-slot"><div class="wiki-card"><div style="font-size:0.75rem; color:var(--sub-text); text-align:right;">[ê¸°ì¡´ ì†Œì„¤] 0. ì„¸ê³„ê´€</div><h1 contenteditable="true" oninput="update('title', this.innerText)">ì„¸ê³„ê´€ ê°œìš”</h1><div id="m-tab" class="side-bookmark author-only" onclick="toggleMemo()">MEMO</div><div id="m-box" class="side-memo-box" contenteditable="true" oninput="update('memo', this.innerText)"></div><button class="author-only" style="position:absolute; top:20px; left:20px; border:none; background:none; color:red; cursor:pointer; font-weight:900; opacity:0.3;" onclick="deleteItem()">âœ• DELETE</button><div style="background:#f0f0f5; color:var(--accent); padding:4px 12px; border-radius:20px; font-size:0.7rem; font-weight:800; display:inline-block; margin-bottom:10px;" contenteditable="true" oninput="update('subCat', this.innerText)">ì†Œë¶„ë¥˜...</div><div class="diff-badge diff-low" onclick="cycleAcc(0)">íŒë³„: ì§‘í•„ ê°€ëŠ¥</div>
                   <div style="background:#f8f9fa; border-left:6px solid var(--accent); padding:20px; border-radius:12px; margin-bottom:20px;" contenteditable="true" oninput="update('analysis', this.innerText)">â—ˆ ì§‘í•„ ë¶„ì„
- íŒë³„ë“±ê¸‰: 
- í•µì‹¬ í‚¤ì›Œë“œ: 
- ì´ˆë³´ì‘ê°€ ì£¼ì˜ì‚¬í•­: 
- ì†Œì„¤ ì£¼ì˜ì‚¬í•­: </div><div class="editor" contenteditable="true" oninput="update('content', this.innerText)">ì²œê° ì‘ê°€ì˜ ìš°ì£¼.</div></div></div>
</main>

<div id="narrative-modal" class="widget-overlay" onclick="toggleNarrativeTable()">
    <div class="widget-card" onclick="event.stopPropagation()">
        <h2 style="margin-top:0;">ğŸ“Š í†µí•© ì„œì‚¬ ëŒ€ì¡°í‘œ</h2>
        <table style="width:100%; border-collapse: collapse;">
            <thead><tr style="background:#f5f5f7; font-size:0.8rem;"><th style="padding:10px; border-bottom:2px solid var(--border);">ì¹´í…Œê³ ë¦¬</th><th style="padding:10px; border-bottom:2px solid var(--border);">ì¸ë¬¼</th><th style="padding:10px; border-bottom:2px solid var(--border);">í–‰ë™ ê¸°ë¡</th></tr></thead>
            <tbody id="narrative-body"></tbody>
        </table>
        <button class="btn-tool" style="margin-top:20px; width:100%;" onclick="toggleNarrativeTable()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const categories = ["0. ì„¸ê³„ê´€", "1. ìºë¦­í„°", "2. ëª¬ìŠ¤í„°(ê³µí†µ)", "3. ì§œíˆ¬ë¦¬", "4. ê°€ê³„ë„", "5. ì—°ëŒ€ê¸°", "6. ë³µì„  í˜„í™©", "7. ìŠ¤í† ë¦¬ë³´ë“œ", "8. ë©€í‹°ë²„ìŠ¤", "9. ì—°ì¬ í˜„í™©"];
    const analysisTemplate = "â—ˆ ì§‘í•„ ë¶„ì„\n- íŒë³„ë“±ê¸‰: \n- í•µì‹¬ í‚¤ì›Œë“œ: \n- ì´ˆë³´ì‘ê°€ ì£¼ì˜ì‚¬í•­: \n- ì†Œì„¤ ì£¼ì˜ì‚¬í•­: ";
    const diffLabels = { "í•˜": "ì§‘í•„ ê°€ëŠ¥", "ì¤‘": "ì™„ê²° í›„ ë„ì „", "ìƒ": "ì§‘í•„ ë‹¹ì¥ ë¶ˆê°€ëŠ¥" };

    let wikiData = [];
    let currentNovel = localStorage.getItem('currentNovel') || "all";
    let currentPage = 1;

    function init() {
        if (window.location.search.includes('mode=read')) document.body.classList.add('reader-mode');
        const keys = ['chunGakData_v30','chunGakData_v29','chunGakData_v28','chunGakData_v27','chunGakData_v26','chunGakData_v23'];
        let recovered = null;
        for (let key of keys) {
            const d = localStorage.getItem(key);
            if (d) { recovered = JSON.parse(d); break; }
        }
        wikiData = recovered || [
            { novel: "ê¸°ì¡´ ì†Œì„¤", type: 0, title: "ì„¸ê³„ê´€ ê°œìš”", analysis: analysisTemplate, accessibility: "í•˜" },
            { novel: "ê¸°ì¡´ ì†Œì„¤", type: 1, title: "ë¡œì¸ ì¹´ë°€ë£¨ìŠ¤", content: "ì£¼ì—­." },
            { novel: "ê¸°ì¡´ ì†Œì„¤", type: 2, title: "ìŠ¤ì¼ˆë ˆí†¤", danger: 2, testimony: "ë¼ˆ ì†Œë¦¬..." }
        ];
        save(); updateSelector(); renderSidebar(); renderPage();
    }

    function renderPage() {
        const slot = document.getElementById('main-card-slot');
        const item = wikiData[currentPage - 1];
        if (!item) return;

        let ui = `<div id="m-tab" class="side-bookmark author-only" onclick="toggleMemo()">MEMO</div><div id="m-box" class="side-memo-box" contenteditable="true" oninput="update('memo', this.innerText)">${item.memo || ''}</div>`;
        ui += `<button class="author-only" style="position:absolute; top:20px; left:20px; border:none; background:none; color:red; cursor:pointer; font-weight:900; opacity:0.3;" onclick="deleteItem()">âœ• DELETE</button>`;
        ui += `<div style="background:#f0f0f5; color:var(--accent); padding:4px 12px; border-radius:20px; font-size:0.7rem; font-weight:800; display:inline-block; margin-bottom:10px;" contenteditable="true" oninput="update('subCat', this.innerText)">${item.subCat || 'ì†Œë¶„ë¥˜...'}</div>`;

        if (item.type === 0) {
            const acc = item.accessibility || "í•˜";
            const bClass = acc === 'ìƒ' ? 'diff-high' : (acc === 'ì¤‘' ? 'diff-mid' : 'diff-low');
            ui += `<div class="diff-badge ${bClass}" onclick="cycleAcc(${currentPage-1})">íŒë³„: ${diffLabels[acc]}</div>
                   <div style="background:#f8f9fa; border-left:6px solid var(--accent); padding:20px; border-radius:12px; margin-bottom:20px;" contenteditable="true" oninput="update('analysis', this.innerText)">${item.analysis || analysisTemplate}</div>`;
        }

        if (item.type === 2 || item.type === 1) {
            ui += `<div class="info-grid"><div class="info-box"><small>ë°°ê²½/ìƒíƒœ</small><div contenteditable="true" oninput="update('habitat',this.innerText)">${item.habitat||''}</div></div><div class="info-box"><small>ì•½ì /ëŠ¥ë ¥</small><div contenteditable="true" oninput="update('weakness',this.innerText)">${item.weakness||''}</div></div></div>`;
            if (item.type === 2) {
                const d = item.danger || 1;
                let sClass = 'star-gold';
                if (d >= 10) sClass = 'star-rainbow'; else if (d === 9) sClass = 'star-gray'; else if (d >= 6) sClass = 'star-red';
                ui += `<div class="star-box ${sClass}" onclick="cycleDanger(${currentPage-1})">${'â˜…'.repeat(d)}${'â˜†'.repeat(10-d)}</div>
                       <div style="background:#fff5f5; border-left:6px solid var(--monster); padding:15px; border-radius:12px;"><b>ì¦ì–¸:</b><div contenteditable="true" oninput="update('testimony', this.innerText)">${item.testimony||''}</div></div>`;
            }
        }

        if (item.type === 4) {
            if(!item.nodes) item.nodes = [{id:Date.now(), name:"ë¡œì¸ ì¹´ë°€ë£¨ìŠ¤", color:"var(--rel-pink)", children:[]}];
            ui += `<div id="org-tree">${renderNodes(item.nodes)}</div>`;
        }

        if (item.type === 6) {
            if(!item.plots) item.plots = [{solved:false, desc:"", sown:"", reaped:""}];
            ui += `<div style="border:1px solid var(--border); border-radius:12px; overflow:hidden; margin:15px 0;">
                <div style="display:grid; grid-template-columns:50px 1fr 80px 80px; padding:10px; background:#fafafa; font-weight:800; font-size:0.8rem;"><span>íšŒìˆ˜</span><span>ë‚´ìš©</span><span>ë¿Œë¦¼</span><span>íšŒìˆ˜</span></div>
                ${item.plots.map((p,i)=>`<div style="display:grid; grid-template-columns:50px 1fr 80px 80px; padding:10px; border-top:1px solid var(--border); align-items:center;"><input type="checkbox" ${p.solved?'checked':''} onchange="updatePlot(${i},'solved',this.checked)"><input style="border:none;outline:none;" value="${p.desc}" oninput="updatePlot(${i},'desc',this.value)"><input style="border:none;outline:none;text-align:center" value="${p.sown}" oninput="updatePlot(${i},'sown',this.value)"><input style="border:none;outline:none;text-align:center" value="${p.reaped}" oninput="updatePlot(${i},'reaped',this.value)"></div>`).join('')}
            </div><button class="btn-tool author-only" onclick="addPlot()">âœš ë³µì„  ì¶”ê°€</button>`;
        }

        if ([5, 7, 8].includes(item.type)) {
            if(!item.actionLogs) item.actionLogs = [{char:"", act:""}];
            const chars = wikiData.filter(d => d.type === 1);
            ui += `<div class="author-only" style="margin-bottom:15px;">${chars.map(c=>`<span style="background:var(--accent); color:#fff; padding:4px 10px; border-radius:6px; font-size:0.75rem; margin-right:5px; cursor:pointer;" onclick="jumpTo('${c.title}')"># ${c.title}</span>`).join('')}</div>
                   <div style="margin:15px 0;">${item.actionLogs.map((l,i)=>`<div class="log-grid"><input class="log-input" placeholder="ì¸ë¬¼" value="${l.char}" oninput="updateLog(${i},'char',this.value)"><input class="log-input" placeholder="í–‰ë™ ê¸°ë¡" value="${l.act}" oninput="updateLog(${i},'act',this.value)"><button class="author-only" style="border:none; background:none; color:red; cursor:pointer;" onclick="delLog(${i})">âœ•</button></div>`).join('')}<button class="btn-tool author-only" onclick="addLog()">âœš ë¡œê·¸ ì¶”ê°€</button></div>`;
        }

        if (item.type === 9) {
            ui += `<div class="author-only" style="display:flex; gap:10px; margin-bottom:20px;"><button class="btn-tool" style="flex:1" onclick="inStat('munCount')">ë¬¸í”¼ì•„ ${item.munCount||0}ì</button><button class="btn-tool" style="flex:1" onclick="inStat('novCount')">ë…¸ë²¨í”¼ì•„ ${item.novCount||0}ì</button></div>`;
        }

        slot.innerHTML = `<div class="wiki-card"><div style="font-size:0.75rem; color:var(--sub-text); text-align:right;">[${item.novel}] ${categories[item.type]}</div><h1 contenteditable="true" oninput="update('title', this.innerText)">${item.title}</h1>${ui}<div class="editor" contenteditable="true" oninput="update('content', this.innerText)">${item.content || ''}</div></div>`;
    }

    // --- [ë¡œì§ í•µì‹¬] ---
    function renderNodes(nodes) { return nodes.map(n => `<div class="org-wrap"><div class="org-card"><div style="width:12px; height:12px; border-radius:50%; background:${n.color}; cursor:pointer;" onclick="cycleColor(${n.id})"></div><span class="org-name" onclick="jumpTo('${n.name}')">${n.name}</span><button class="author-only" style="border:none;background:none;cursor:pointer;" onclick="addNode(${n.id})">ï¼‹</button><button class="author-only" style="border:none;background:none;cursor:pointer;color:red;" onclick="delNode(${n.id})">ï¼</button></div>${n.children?renderNodes(n.children):''}</div>`).join(''); }
    function cycleAcc(i) { const o=["í•˜","ì¤‘","ìƒ"]; wikiData[i].accessibility=o[(o.indexOf(wikiData[i].accessibility||"í•˜")+1)%3]; save(); renderPage(); }
    function cycleDanger(i) { let d=wikiData[i].danger||1; wikiData[i].danger=d>=10?1:d+1; save(); renderPage(); }
    function cycleColor(id) { const cs=["var(--rel-black)","var(--rel-pink)","var(--rel-blue)","var(--rel-red)"]; const f=(l)=>l.forEach(n=>{if(n.id===id)n.color=cs[(cs.indexOf(n.color)+1)%4];else f(n.children);}); f(wikiData[currentPage-1].nodes); save(); renderPage(); }
    function updateLog(i,f,v) { wikiData[currentPage-1].actionLogs[i][f]=v; save(); }
    function addLog() { wikiData[currentPage-1].actionLogs.push({char:"",act:""}); renderPage(); }
    function delLog(i) { wikiData[currentPage-1].actionLogs.splice(i,1); renderPage(); }
    function updatePlot(i,f,v) { wikiData[currentPage-1].plots[i][f]=v; save(); }
    function addPlot() { wikiData[currentPage-1].plots.push({solved:false,desc:"",sown:"",reaped:""}); renderPage(); }
    function toggleNarrativeTable() {
        const modal = document.getElementById('narrative-modal'); const body = document.getElementById('narrative-body');
        if (modal.style.display === 'flex') { modal.style.display = 'none'; return; }
        body.innerHTML = ""; wikiData.forEach(item => { if(item.actionLogs) item.actionLogs.forEach(l => { if(l.char||l.act) body.innerHTML += `<tr style="border-bottom:1px solid #eee;"><td style="padding:10px;">${categories[item.type]}</td><td style="padding:10px;"><b>${l.char}</b></td><td style="padding:10px;">${l.act}</td></tr>`; })});
        modal.style.display = 'flex';
    }
    function update(f,v) { wikiData[currentPage-1][f]=v; save(); if(f==='title') renderSidebar(); }
    function save() { localStorage.setItem('chunGakData_v30.2', JSON.stringify(wikiData)); }
    function switchNovel(n) { currentNovel=n; localStorage.setItem('currentNovel',n); updateSelector(); renderSidebar(); currentPage=1; renderPage(); }
    function setTheme(c) { document.documentElement.style.setProperty('--accent',c); localStorage.setItem('chunGakTheme', c); }
    function jumpTo(name) { const idx=wikiData.findIndex(d=>d.type===1 && d.title===name); if(idx!==-1){ currentPage=idx+1; renderPage(); renderSidebar(); } }
    function goPage(n) { currentPage=n; renderPage(); renderSidebar(); }
    function toggleMemo() { document.getElementById('m-tab').classList.toggle('active'); document.getElementById('m-box').classList.toggle('active'); }
    function addNode(id) { const f=(l)=>l.forEach(n=>n.id===id?n.children.push({id:Date.now(), name:"ìƒˆ ì¸ë¬¼", color:"var(--rel-black)", children:[]}):f(n.children)); f(wikiData[currentPage-1].nodes); save(); renderPage(); }
    function delNode(id) { const f=(l)=>{const i=l.findIndex(n=>n.id===id); if(i!==-1)l.splice(i,1); else l.forEach(n=>f(n.children));}; f(wikiData[currentPage-1].nodes); save(); renderPage(); }
    function copyFullSource() { navigator.clipboard.writeText(document.documentElement.outerHTML); alert("ì „ì²´ ì†ŒìŠ¤ ë³µì‚¬ ì™„ë£Œ!"); }
    
    // [ìˆ˜ì •] ğŸ”— ë…ììš© ë§í¬ ë³µì‚¬: GitHub ê³µì‹ ì›¹ ì£¼ì†Œ ê¸°ì¤€
    function copyReaderLink() {
        const githubURL = "https://sasayus.github.io/library/";
        const readerLink = githubURL + "?mode=read";
        navigator.clipboard.writeText(readerLink).then(() => {
            alert("ë…ììš© ì›¹ ë§í¬(GitHub)ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n" + readerLink);
        });
    }

    function exportData() { const b=new Blob([JSON.stringify(wikiData)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`backup.json`; a.click(); }
    function updateSelector() {
        const sel = document.getElementById('novel-selector'); const ns = [...new Set(wikiData.map(d=>d.novel))].filter(n=>n);
        sel.innerHTML = '<option value="all">ì „ì²´ í”„ë¡œì íŠ¸ ë³´ê¸°</option>'; ns.forEach(n=>sel.innerHTML+=`<option value="${n}" ${currentNovel===n?'selected':''}>${n}</option>`);
    }
    function renderSidebar() {
        const menu = document.getElementById('sidebar-menu'); menu.innerHTML = '';
        const filtered = currentNovel === "all" ? wikiData : wikiData.filter(d=>d.novel===currentNovel || d.type === 2);
        [0,1,2,3,4,5,6,7,8,9].forEach(type => {
            const items = filtered.filter(d=>d.type===type);
            if (items.length === 0 && type !== 2) return;
            menu.innerHTML += `<div class="side-cat side-cat-${type}"><span>${categories[type]}</span><span class="author-only" onclick="addItem(${type})">+</span></div>`;
            items.forEach(item => { const idx=wikiData.indexOf(item); menu.innerHTML += `<div class="side-item ${idx===currentPage-1?'active' :''}" onclick="goPage(${idx+1})">${item.title}</div>`; });
        });
    }
    function createProject(name) { categories.forEach((cat,idx) => { wikiData.push({novel:name, type:idx, title:`${cat} ì´ˆê¸° í•­ëª©`, content:"", danger:1}); }); save(); }
    function createNewProject() { const name=prompt("ì†Œì„¤ ì œëª©:"); if(name){ createProject(name); switchNovel(name); } }
    function deleteEntireProject() { if(confirm('í”„ë¡œì íŠ¸ ì „ì²´ ì‚­ì œ?')){ wikiData=wikiData.filter(d=>d.novel!==currentNovel); save(); switchNovel("all"); } }
    function deleteItem() { if(confirm('ì‚­ì œ?')){ wikiData.splice(currentPage-1,1); save(); currentPage=1; renderPage(); renderSidebar(); } }
    function addItem(t) { wikiData.push({novel:currentNovel==="all"?"ê¸°ë³¸":currentNovel, type:t, title:"ìƒˆ í•­ëª©", content:"", danger:1}); save(); renderSidebar(); }
    function inStat(f) { const v=prompt("ê¸€ììˆ˜:"); if(v){ wikiData[currentPage-1][f]=v; save(); renderPage(); } }
</script>

</body></html>

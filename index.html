<html lang="ko"><head>
    <meta charset="UTF-8">
    <title>ì‘ê°€ ì²œê° ì•„ì¹´ì´ë¸Œ V3 (Final Master)</title>
    <style>
        :root { 
            --bg: #f5f5f7; --card: #ffffff; --sidebar: #ffffff;
            --text: #1d1d1f; --sub-text: #86868b; --accent: #1d1d1f; 
            --border: #e5e5e7; --shadow: 0 12px 40px rgba(0,0,0,0.08);
            --munpia: #d32f2f; --novel: #1976d2; --monster: #d70015;
            --rel-pink: #ff2d55; --rel-blue: #007aff; --rel-red: #ff3b30;
            --bookmark: #ffcc00; --star-gold: #ffcc00; --star-red: #ff3b30;
            --low: #34c759; --mid: #ffcc00; --high: #ff3b30;
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); display: flex; margin: 0; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        /* ë…ì ëª¨ë“œ: 0(ì„¸ê³„ê´€), 6(ë³µì„ ), 9(ì—°ì¬) ë° ì‘ê°€ ë„êµ¬ ì „ë©´ ì€í */
        body.reader-mode .author-only, 
        body.reader-mode .side-cat-0, 
        body.reader-mode .side-cat-6, 
        body.reader-mode .side-cat-9 { display: none !important; }

        /* ì‚¬ì´ë“œë°” ì ‘ê¸° */
        nav { width: 300px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 25px 20px; overflow-y: auto; display: flex; flex-direction: column; z-index: 100; transition: 0.4s; position: relative; }
        nav.folded { width: 0; padding: 0; border-right: none; transform: translateX(-300px); }
        .toggle-btn { position: fixed; left: 310px; top: 20px; z-index: 200; background: var(--card); border: 1px solid var(--border); border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); transition: 0.4s; font-size: 0.8rem; font-weight: 900; }
        nav.folded + .toggle-btn { left: 20px; transform: rotate(180deg); }

        .theme-dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .novel-selector { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; font-weight: 700; background: var(--card); border-left: 5px solid var(--accent); cursor: pointer; outline: none; }
        .side-cat { font-size: 0.75rem; color: var(--accent); font-weight: 800; margin-top: 18px; border-bottom: 1px solid var(--border); padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .side-item { font-size: 0.85rem; padding: 10px 14px; cursor: pointer; border-radius: 8px; margin-top: 4px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .side-item.active { background: var(--accent); color: #fff; font-weight: 700; }

        /* ë©”ì¸ ì—ë””í„° */
        main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 60px; align-items: center; position: relative; transition: 0.4s; }
        .wiki-card { background: var(--card); padding: 60px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.03); width: 100%; max-width: 900px; min-height: 800px; border-top: 10px solid var(--accent); position: relative; }
        .editor { line-height: 2.1; font-size: 1.15rem; outline: none; min-height: 350px; white-space: pre-wrap; padding: 25px; background: rgba(0,0,0,0.015); border-radius: 14px; border: 1px solid var(--border); margin-top: 25px; }

        /* ë‚œì´ë„ UI */
        .diff-selector { display: flex; background: #eee; border-radius: 12px; padding: 4px; gap: 4px; width: fit-content; margin-bottom: 25px; }
        .diff-opt { padding: 10px 22px; border-radius: 8px; font-size: 0.85rem; font-weight: 800; cursor: pointer; transition: 0.3s; color: #888; border: none; }
        .diff-opt.active.low { background: var(--low); color: white; box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4); }
        .diff-opt.active.mid { background: var(--mid); color: white; box-shadow: 0 4px 12px rgba(255, 204, 0, 0.4); }
        .diff-opt.active.high { background: var(--high); color: white; box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4); }

        /* ìºë¦­í„° ì í”„ íƒœê·¸ */
        .char-tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; padding: 15px; background: #f1f2f6; border-radius: 12px; border-left: 5px solid var(--accent); }
        .char-tag { background: var(--accent); color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .char-tag:hover { filter: brightness(1.2); transform: translateY(-2px); }

        /* ëª¬ìŠ¤í„° ë³„ì  */
        .star-box { font-size: 1.5rem; letter-spacing: 5px; cursor: pointer; display: inline-block; margin: 10px 0; }
        .star-rainbow { background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 2s infinite linear; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .star-red { color: var(--star-red) !important; } .star-gold { color: var(--star-gold) !important; }

        /* ê·¸ë¦¬ë“œ ë° ìœ„ì ¯ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .info-box { background: #f9f9fb; padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .log-grid { display: grid; grid-template-columns: 120px 1fr 40px; gap: 8px; margin-bottom: 8px; background: #f9f9fb; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .log-input { border: 1px solid var(--border); padding: 8px; border-radius: 6px; font-size: 0.85rem; outline: none; background: #fff; width: 100%; box-sizing: border-box; }
        .plot-table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .plot-table th { background: #fafafa; font-size: 0.8rem; padding: 10px; border-bottom: 1px solid var(--border); }
        .plot-table td { padding: 10px; border-bottom: 1px solid var(--border); background: #fff; }

        /* ìº˜ë¦°ë” */
        .cal-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day { aspect-ratio: 1/1; border: 1px solid var(--border); border-radius: 8px; position: relative; overflow: hidden; cursor: pointer; background: #fff; }
        .stamp-m { position: absolute; left: 0; width: 50%; height: 100%; background: rgba(211,47,47,0.2); display: flex; align-items:center; justify-content:center; color: var(--munpia); font-weight: 900; font-size: 0.6rem; opacity: 0; }
        .stamp-n { position: absolute; right: 0; width: 50%; height: 100%; background: rgba(25,118,210,0.2); display: flex; align-items:center; justify-content:center; color: var(--novel); font-weight: 900; font-size: 0.6rem; opacity: 0; }
        .stamp-m.done, .stamp-n.done { opacity: 1; }

        /* ì‘ê°€ ë„êµ¬ íŒ¨ë„ */
        .author-tools { display: flex; flex-direction: column; gap: 6px; border-top: 1px solid var(--border); padding-top: 20px; margin-top: auto; }
        .btn-tool { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.75rem; text-align: center; }
        .side-bookmark { position: absolute; top: 150px; right: -15px; width: 22px; height: 90px; background: #ffcc00; font-weight: 900; writing-mode: vertical-rl; text-align: center; border-radius: 6px 0 0 6px; cursor: pointer; z-index: 100; transition: 0.3s; font-size: 0.75rem; }
        .side-memo-box { position: absolute; top: 150px; right: -320px; width: 280px; height: 400px; background: #fff9c4; border-radius: 15px; padding: 25px; box-shadow: 10px 10px 30px rgba(0,0,0,0.1); z-index: 99; transition: 0.3s; display: none; border-left: 8px solid #fbc02d; font-family: 'Nanum Pen Script', cursive; overflow-y: auto; }
        .side-memo-box.active { right: 5px; display: block; }
        .widget-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .widget-card { background: #fff; width: 90%; max-width: 1000px; height: 80%; border-radius: 24px; padding: 40px; overflow-y: auto; }
    </style>
</head>
<body onload="init()">

<nav id="sidebar">
    <h2 onclick="location.reload()" style="cursor:pointer;">CHUNGAK ARCHIVE V3</h2>
    <div class="theme-dots author-only">
        <div class="dot" style="background:#1d1d1f" onclick="setTheme('#1d1d1f')"></div>
        <div class="dot" style="background:#b71c1c" onclick="setTheme('#b71c1c')"></div>
        <div class="dot" style="background:#1a237e" onclick="setTheme('#1a237e')"></div>
        <div class="dot" style="background:#1b5e20" onclick="setTheme('#1b5e20')"></div>
    </div>
    <select id="novel-selector" class="novel-selector" onchange="switchNovel(this.value)"><option value="all">ì „ì²´ í”„ë¡œì íŠ¸ ë³´ê¸°</option><option value="ì¡°ì„  íŒíƒ€ì§€">ì¡°ì„  íŒíƒ€ì§€</option><option value="ê³ ê·€í•œ ë±€íŒŒì´ì–´" selected="">ê³ ê·€í•œ ë±€íŒŒì´ì–´</option></select>
    <div id="sidebar-menu"><div class="side-cat side-cat-0"><span>0. ì„¸ê³„ê´€</span><span class="author-only" onclick="addItem(0)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(11)">0. ì„¸ê³„ê´€ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-1"><span>1. ìºë¦­í„°</span><span class="author-only" onclick="addItem(1)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(12)">1. ìºë¦­í„° ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-2"><span>2. ëª¬ìŠ¤í„°(ê³µí†µ)</span><span class="author-only" onclick="addItem(2)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(1)">ìŠ¤ì¼ˆë ˆí†¤</div><div class="side-cat side-cat-3"><span>3. ì§œíˆ¬ë¦¬</span><span class="author-only" onclick="addItem(3)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(13)">3. ì§œíˆ¬ë¦¬ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-4"><span>4. ê°€ê³„ë„</span><span class="author-only" onclick="addItem(4)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(14)">4. ê°€ê³„ë„ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-5"><span>5. ì—°ëŒ€ê¸°</span><span class="author-only" onclick="addItem(5)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(15)">5. ì—°ëŒ€ê¸° ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-6"><span>6. ë³µì„  í˜„í™©</span><span class="author-only" onclick="addItem(6)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(16)">6. ë³µì„  í˜„í™© ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-7"><span>7. ìŠ¤í† ë¦¬ë³´ë“œ</span><span class="author-only" onclick="addItem(7)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(17)">7. ìŠ¤í† ë¦¬ë³´ë“œ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-8"><span>8. ë©€í‹°ë²„ìŠ¤</span><span class="author-only" onclick="addItem(8)" style="cursor:pointer;">+</span></div><div class="side-item " onclick="goPage(18)">8. ë©€í‹°ë²„ìŠ¤ ì´ˆê¸° í•­ëª©</div><div class="side-cat side-cat-9"><span>9. ì—°ì¬ &amp; ìº˜ë¦°ë”</span><span class="author-only" onclick="addItem(9)" style="cursor:pointer;">+</span></div><div class="side-item active" onclick="goPage(19)">9. ì—°ì¬ &amp; ìº˜ë¦°ë” ì´ˆê¸° í•­ëª©</div></div>
    <div class="author-tools author-only">
        <button class="btn-tool" style="background:var(--accent); color:#fff;" onclick="copyFullSource()">ğŸ’¾ ì „ì²´ ì†ŒìŠ¤ ë³µì‚¬</button>
        <button class="btn-tool" style="color:var(--novel);" onclick="copyReaderLink()">ğŸ”— ë…ììš© ë§í¬ ìƒì„±</button>
        <button class="btn-tool" onclick="toggleNarrativeTable()">ğŸ“Š ì„œì‚¬ ëŒ€ì¡°í‘œ ë³´ê¸°</button>
        <button class="btn-tool" style="color:#28a745;" onclick="createNewProject()">âœš ìƒˆ ì†Œì„¤ ì¶”ê°€</button>
        <button class="btn-tool" onclick="exportData()">ë°ì´í„° ë°±ì—…(JSON)</button>
        <button class="btn-tool" style="color:var(--rel-red);" onclick="deleteEntireProject()">âš ï¸ í”„ë¡œì íŠ¸ ì „ì²´ ì‚­ì œ</button>
    </div>
</nav>

<div class="toggle-btn author-only" onclick="toggleSidebar()">â—€</div>

<main id="main-content">
    <div id="main-card-slot"><div class="wiki-card">
            <div style="font-size:0.75rem; color:var(--sub-text); text-align:right;">[ê³ ê·€í•œ ë±€íŒŒì´ì–´] 9. ì—°ì¬ &amp; ìº˜ë¦°ë”</div>
            <h1 contenteditable="true" oninput="update('title', this.innerText)">9. ì—°ì¬ &amp; ìº˜ë¦°ë” ì´ˆê¸° í•­ëª©</h1><div id="m-tab" class="side-bookmark author-only" onclick="toggleMemo()">MEMO</div><div id="m-box" class="side-memo-box" contenteditable="true" oninput="update('memo', this.innerText)"></div><button class="author-only" style="position:absolute; top:20px; left:20px; border:none; background:none; color:red; cursor:pointer; font-weight:900; opacity:0.3;" onclick="deleteItem()">âœ• DELETE</button><div style="background:#f1f2f6; padding:20px; border-radius:15px; margin-bottom:20px;" class="author-only">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <a href="https://gemini.google.com/" target="_blank" class="btn-tool" style="flex:2; background:var(--novel); color:#fff; text-decoration:none;">ğŸ¯ AI í‡´ê³  ê²€ìˆ˜</a>
                    <button class="btn-tool" style="flex:1" onclick="applyStamp('m')">M ë„ì¥</button>
                    <button class="btn-tool" style="flex:1" onclick="applyStamp('n')">N ë„ì¥</button>
                </div>
                <b>í˜„í™©: ê³µë°± ì œì™¸ 0ì / ì„ íƒ ë‚ ì§œ: 2026-01-29</b>
            </div>
            <div class="cal-container"><div style="border:1px solid var(--border); padding:10px; border-radius:10px; background:#fff;"><b>1ì›”</b><div class="cal-grid"><div></div><div></div><div></div><div></div><div class="cal-day " onclick="selectDate('2026-01-01')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">1</small></div><div class="cal-day " onclick="selectDate('2026-01-02')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">2</small></div><div class="cal-day " onclick="selectDate('2026-01-03')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">3</small></div><div class="cal-day " onclick="selectDate('2026-01-04')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">4</small></div><div class="cal-day " onclick="selectDate('2026-01-05')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">5</small></div><div class="cal-day " onclick="selectDate('2026-01-06')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">6</small></div><div class="cal-day " onclick="selectDate('2026-01-07')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">7</small></div><div class="cal-day " onclick="selectDate('2026-01-08')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">8</small></div><div class="cal-day " onclick="selectDate('2026-01-09')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">9</small></div><div class="cal-day " onclick="selectDate('2026-01-10')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">10</small></div><div class="cal-day " onclick="selectDate('2026-01-11')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">11</small></div><div class="cal-day " onclick="selectDate('2026-01-12')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">12</small></div><div class="cal-day " onclick="selectDate('2026-01-13')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">13</small></div><div class="cal-day " onclick="selectDate('2026-01-14')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">14</small></div><div class="cal-day " onclick="selectDate('2026-01-15')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">15</small></div><div class="cal-day " onclick="selectDate('2026-01-16')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">16</small></div><div class="cal-day " onclick="selectDate('2026-01-17')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">17</small></div><div class="cal-day " onclick="selectDate('2026-01-18')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">18</small></div><div class="cal-day " onclick="selectDate('2026-01-19')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">19</small></div><div class="cal-day " onclick="selectDate('2026-01-20')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">20</small></div><div class="cal-day " onclick="selectDate('2026-01-21')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">21</small></div><div class="cal-day " onclick="selectDate('2026-01-22')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">22</small></div><div class="cal-day " onclick="selectDate('2026-01-23')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">23</small></div><div class="cal-day " onclick="selectDate('2026-01-24')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">24</small></div><div class="cal-day " onclick="selectDate('2026-01-25')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">25</small></div><div class="cal-day " onclick="selectDate('2026-01-26')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">26</small></div><div class="cal-day " onclick="selectDate('2026-01-27')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">27</small></div><div class="cal-day " onclick="selectDate('2026-01-28')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">28</small></div><div class="cal-day active" onclick="selectDate('2026-01-29')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">29</small></div><div class="cal-day " onclick="selectDate('2026-01-30')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">30</small></div><div class="cal-day " onclick="selectDate('2026-01-31')"><div class="stamp-m ">M</div><div class="stamp-n ">N</div><small style="position:relative;z-index:2;padding:2px;">31</small></div></div></div></div>
            <div class="author-only" style="margin-top:20px; text-align:center;"><button class="btn-tool" onclick="addMonth()">âœš ë‹¤ìŒ ë‹¬ ì¶”ê°€</button></div>
            <div class="editor" contenteditable="true" oninput="update('content', this.innerText)" onkeyup="if(9===9) renderPage()"></div>
        </div></div>
</main>

<div id="narrative-modal" class="widget-overlay" onclick="toggleNarrativeTable()">
    <div class="widget-card" onclick="event.stopPropagation()">
        <h2 style="margin-top:0;">ğŸ“Š í†µí•© ì„œì‚¬ ëŒ€ì¡°í‘œ</h2>
        <table style="width:100%; border-collapse: collapse;">
            <thead><tr style="background:#f5f5f7; font-size:0.8rem;"><th style="padding:10px; border-bottom:2px solid var(--border);">ì¹´í…Œê³ ë¦¬</th><th style="padding:10px; border-bottom:2px solid var(--border);">ì¸ë¬¼</th><th style="padding:10px; border-bottom:2px solid var(--border);">í–‰ë™ ê¸°ë¡</th></tr></thead>
            <tbody id="narrative-body"></tbody>
        </table>
        <button class="btn-tool" style="margin-top:20px; width:100%;" onclick="toggleNarrativeTable()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const categories = ["0. ì„¸ê³„ê´€", "1. ìºë¦­í„°", "2. ëª¬ìŠ¤í„°(ê³µí†µ)", "3. ì§œíˆ¬ë¦¬", "4. ê°€ê³„ë„", "5. ì—°ëŒ€ê¸°", "6. ë³µì„  í˜„í™©", "7. ìŠ¤í† ë¦¬ë³´ë“œ", "8. ë©€í‹°ë²„ìŠ¤", "9. ì—°ì¬ & ìº˜ë¦°ë”"];
    const analysisTemplate = "â—ˆ ì§‘í•„ ë¶„ì„\n- ë¡œê·¸ë¼ì¸: \n- ì§‘í•„ ë‚œì´ë„ íŒë³„: \n- ì„¸ê³„ê´€ ë¶„ì„: \n- ê¸€ì„ ì“¸ ë•Œì˜ ì£¼ì˜ì‚¬í•­: \n- ì´ˆë³´ ì‘ê°€ë¡œì„œì˜ ì£¼ì˜ ì‚¬í•­: ";

    let wikiData = [];
    let currentNovel = localStorage.getItem('currentNovel') || "all";
    let currentPage = 1;
    let selectedDate = new Date().toISOString().split('T')[0];

    function init() {
        if (window.location.search.includes('mode=read')) document.body.classList.add('reader-mode');
        const saved = localStorage.getItem('chunGakData_v3');
        if (saved) {
            wikiData = JSON.parse(saved);
        } else {
            wikiData = [
                { novel: "ì „ìƒìƒê´‘ì¦", type: 0, title: "ì„¸ê³„ê´€ ê°œìš”", analysis: analysisTemplate, accessibility: "í•˜" },
                { novel: "ì „ìƒìƒê´‘ì¦", type: 1, title: "ë¡œì¸ ì¹´ë°€ë£¨ìŠ¤", habitat: "ì§€í•˜ ê±°ì£¼êµ¬", weakness: "ë§ˆë ¥ ë°˜ë™", content: "ê±´ë¸”ë ˆì´ë“œ ì‚¬ìš©ì." },
                { novel: "ê³µí†µ", type: 2, title: "ìŠ¤ì¼ˆë ˆí†¤", danger: 10, habitat: "ë˜ì „", weakness: "íƒ€ê²©/ì„±ì†ì„±", testimony: "ë¼ˆ ì†Œë¦¬ê°€ ë“¤ë¦¬ë©´ ëŠ¦ì—ˆë‹¤." },
                { novel: "ì „ìƒìƒê´‘ì¦", type: 9, title: "2026 ì—°ì¬ & ìº˜ë¦°ë”", stamps: {}, visibleMonths: 1 }
            ];
        }
        save(); updateSelector(); renderSidebar(); renderPage();
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('folded'); }

    function renderPage() {
        const slot = document.getElementById('main-card-slot');
        const item = wikiData[currentPage - 1];
        if (!item) return;

        // [ë²„ê·¸ ìˆ˜ì •] ë…ì ëª¨ë“œì¸ì§€ í™•ì¸
        const isReader = document.body.classList.contains('reader-mode');

        // [ì„œì‚¬ ê°€ì´ë“œ] ìºë¦­í„° ë¶€ì¬ ì‹œ ì•ˆë‚´
        if (!isReader && [5, 7, 8].includes(item.type)) {
            const currentChars = wikiData.filter(d => d.type === 1 && (d.novel === currentNovel || d.novel === "ê³µí†µ"));
            if (currentChars.length === 0) {
                alert("ì„œì‚¬ì˜ ì£¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìºë¦­í„°ë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”!");
                addItem(1); return;
            }
        }

        let ui = `<div id="m-tab" class="side-bookmark author-only" onclick="toggleMemo()">MEMO</div><div id="m-box" class="side-memo-box" contenteditable="true" oninput="update('memo', this.innerText)">${item.memo || ''}</div>`;
        ui += `<button class="author-only" style="position:absolute; top:20px; left:20px; border:none; background:none; color:red; cursor:pointer; font-weight:900; opacity:0.3;" onclick="deleteItem()">âœ• DELETE</button>`;

        // ìºë¦­í„° ì í”„ íƒœê·¸
        if ([5, 7, 8].includes(item.type)) {
            const chars = wikiData.filter(d => d.type === 1 && (d.novel === currentNovel || d.novel === "ê³µí†µ"));
            ui += `<div class="char-tag-container"><small style="width:100%; margin-bottom:5px; font-weight:800; color:var(--sub-text);"># ìºë¦­í„° ìƒì„¸ ì„¤ì •:</small>${chars.map(c => `<span class="char-tag" onclick="jumpToChar('${c.title}')">${c.title}</span>`).join('')}</div>`;
        }

        if (item.type === 1 || item.type === 2) {
            ui += `<div class="info-grid">
                <div class="info-box"><small>ë°°ê²½/ìƒíƒœ</small><div contenteditable="${!isReader}" oninput="update('habitat',this.innerText)" style="outline:none;">${item.habitat||''}</div></div>
                <div class="info-box"><small>ì•½ì /ëŠ¥ë ¥</small><div contenteditable="${!isReader}" oninput="update('weakness',this.innerText)" style="outline:none;">${item.weakness||''}</div></div>
            </div>`;
            if (item.type === 2) {
                const d = item.danger || 1;
                let sClass = (d >= 10) ? 'star-rainbow' : (d >= 6 ? 'star-red' : 'star-gold');
                ui += `<div class="star-box ${sClass}" onclick="${!isReader ? 'cycleDanger('+(currentPage-1)+')' : ''}">${'â˜…'.repeat(d)}${'â˜†'.repeat(10-d)}</div>
                       <div style="background:#fff5f5; border-left:6px solid var(--monster); padding:15px; border-radius:12px; margin-top:15px;"><b>ì¦ì–¸:</b><div contenteditable="${!isReader}" oninput="update('testimony', this.innerText)" style="outline:none;">${item.testimony||''}</div></div>`;
            }
        }

        if (item.type === 0) {
            const acc = item.accessibility || "í•˜";
            ui += `<div class="diff-selector author-only">
                <div class="diff-opt low ${acc==='í•˜'?'active':''}" onclick="setAcc('í•˜')">ë‹¹ì¥ ì§‘í•„</div>
                <div class="diff-opt mid ${acc==='ì¤‘'?'active':''}" onclick="setAcc('ì¤‘')">í˜„ì¬ëŠ” ì–´ë ¤ì›€</div>
                <div class="diff-opt high ${acc==='ìƒ'?'active':''}" onclick="setAcc('ìƒ')">í•œì°¸ ë’¤ì— ì§‘í•„</div>
            </div>
            <div style="background:#f8f9fa; border-left:6px solid var(--accent); padding:20px; border-radius:12px; margin-bottom:20px;" contenteditable="${!isReader}" oninput="update('analysis', this.innerText)">${item.analysis || analysisTemplate}</div>`;
        }

        if (item.type === 6) {
            if(!item.plots) item.plots = [{solved:false, desc:"", sown:"", reaped:""}];
            ui += `<table class="plot-table">
                <thead><tr><th>íšŒìˆ˜</th><th>ë‚´ìš©</th><th>ë¿Œë¦¼</th><th>íšŒìˆ˜</th><th class="author-only">âœ•</th></tr></thead>
                <tbody>${item.plots.map((p,i)=>`<tr>
                    <td><input type="checkbox" ${p.solved?'checked':''} ${isReader?'disabled':''} onchange="updatePlot(${i},'solved',this.checked)"></td>
                    <td><input class="log-input" style="width:100%" value="${p.desc}" ${isReader?'readonly':''} oninput="updatePlot(${i},'desc',this.value)"></td>
                    <td><input class="log-input" style="width:100%; text-align:center" value="${p.sown}" ${isReader?'readonly':''} oninput="updatePlot(${i},'sown',this.value)"></td>
                    <td><input class="log-input" style="width:100%; text-align:center" value="${p.reaped}" ${isReader?'readonly':''} oninput="updatePlot(${i},'reaped',this.value)"></td>
                    <td class="author-only"><button onclick="delPlot(${i})" style="border:none;background:none;color:red;cursor:pointer">âœ•</button></td>
                </tr>`).join('')}</tbody>
            </table><button class="btn-tool author-only" onclick="addPlot()">âœš ë³µì„  ì¶”ê°€</button>`;
        }

        if (item.type === 9) {
            const txt = item.content || '';
            const cleanLen = txt.replace(/\s/g,'').length;
            ui += `<div style="background:#f1f2f6; padding:20px; border-radius:15px; margin-bottom:20px;" class="author-only">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <a href="https://gemini.google.com/" target="_blank" class="btn-tool" style="flex:2; background:var(--novel); color:#fff; text-decoration:none;">ğŸ¯ AI í‡´ê³  ê²€ìˆ˜</a>
                    <button class="btn-tool" style="flex:1" onclick="applyStamp('m')">M ë„ì¥</button>
                    <button class="btn-tool" style="flex:1" onclick="applyStamp('n')">N ë„ì¥</button>
                </div>
                <b>í˜„í™©: ê³µë°± ì œì™¸ ${cleanLen}ì / ì„ íƒ ë‚ ì§œ: ${selectedDate}</b>
            </div>
            <div class="cal-container">${Array.from({length: item.visibleMonths || 1}, (_, i) => renderMonth(2026, i + 1, item.stamps || {})).join('')}</div>
            <div class="author-only" style="margin-top:20px; text-align:center;"><button class="btn-tool" onclick="addMonth()">âœš ë‹¤ìŒ ë‹¬ ì¶”ê°€</button></div>`;
        }

        if ([4, 5, 7, 8].includes(item.type)) {
            if(!item.actionLogs) item.actionLogs = [{char:"", act:""}];
            ui += `<div>${item.actionLogs.map((l,i)=>`<div class="log-grid">
                <input class="log-input" placeholder="ì¸ë¬¼/ë‹¨ê³„" value="${l.char}" ${isReader?'readonly':''} oninput="updateLog(${i},'char',this.value)">
                <input class="log-input" placeholder="ë‚´ìš©/í–‰ë™" value="${l.act}" ${isReader?'readonly':''} oninput="updateLog(${i},'act',this.value)">
                <button class="author-only" onclick="delLog(${i})" style="border:none; background:none; color:red; cursor:pointer;">âœ•</button>
            </div>`).join('')}<button class="btn-tool author-only" onclick="addLog()">âœš í•­ëª© ì¶”ê°€</button></div>`;
        }

        slot.innerHTML = `<div class="wiki-card">
            <div style="font-size:0.75rem; color:var(--sub-text); text-align:right;">[${item.novel}] ${categories[item.type]}</div>
            <h1 contenteditable="${!isReader}" oninput="update('title', this.innerText)">${item.title}</h1>${ui}
            <div class="editor" contenteditable="${!isReader}" oninput="update('content', this.innerText)" onkeyup="if(${item.type}===9) renderPage()">${item.content || ''}</div>
        </div>`;
    }

    // ë¡œì§ ì œì–´
    function jumpToChar(name) {
        const idx = wikiData.findIndex(d => d.type === 1 && d.title === name);
        if (idx !== -1) { currentPage = idx + 1; renderPage(); renderSidebar(); }
    }
    function setAcc(v) { wikiData[currentPage-1].accessibility = v; save(); renderPage(); }
    function cycleDanger(i) { let d=wikiData[i].danger||1; wikiData[i].danger=d>=10?1:d+1; save(); renderPage(); }
    function updateLog(i,f,v) { wikiData[currentPage-1].actionLogs[i][f]=v; save(); }
    function addLog() { wikiData[currentPage-1].actionLogs.push({char:"",act:""}); renderPage(); }
    function delLog(i) { wikiData[currentPage-1].actionLogs.splice(i,1); renderPage(); }
    function updatePlot(i,f,v) { wikiData[currentPage-1].plots[i][f]=v; save(); }
    function addPlot() { wikiData[currentPage-1].plots.push({solved:false,desc:"",sown:"",reaped:""}); renderPage(); }
    function delPlot(i) { wikiData[currentPage-1].plots.splice(i,1); renderPage(); }
    function save() { localStorage.setItem('chunGakData_v3', JSON.stringify(wikiData)); }
    function update(f,v) { wikiData[currentPage-1][f]=v; save(); if(f==='title') renderSidebar(); }
    function switchNovel(n) { currentNovel=n; localStorage.setItem('currentNovel',n); updateSelector(); renderSidebar(); currentPage=1; renderPage(); }
    function goPage(n) { currentPage=n; renderPage(); renderSidebar(); }
    
    function renderSidebar() {
        const menu = document.getElementById('sidebar-menu'); menu.innerHTML = '';
        const filtered = currentNovel === "all" ? wikiData : wikiData.filter(d => d.novel === currentNovel || d.novel === "ê³µí†µ" || d.type === 2);
        categories.forEach((cat, type) => {
            const items = filtered.filter(d => d.type === type);
            if (items.length === 0 && type !== 2) return;
            menu.innerHTML += `<div class="side-cat side-cat-${type}"><span>${cat}</span><span class="author-only" onclick="addItem(${type})" style="cursor:pointer;">+</span></div>`;
            items.forEach(item => { const idx = wikiData.indexOf(item); menu.innerHTML += `<div class="side-item ${idx===currentPage-1?'active':''}" onclick="goPage(${idx+1})">${item.title}</div>`; });
        });
    }

    function renderMonth(y, m, stamps) {
        const days = new Date(y, m, 0).getDate(); const start = new Date(y, m-1, 1).getDay();
        let html = `<div style="border:1px solid var(--border); padding:10px; border-radius:10px; background:#fff;"><b>${m}ì›”</b><div class="cal-grid">`;
        for(let i=0; i<start; i++) html += `<div></div>`;
        for(let d=1; d<=days; d++) {
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const s = stamps[dateStr] || {m:false, n:false};
            html += `<div class="cal-day ${selectedDate===dateStr?'active':''}" onclick="selectDate('${dateStr}')"><div class="stamp-m ${s.m?'done':''}">M</div><div class="stamp-n ${s.n?'done':''}">N</div><small style="position:relative;z-index:2;padding:2px;">${d}</small></div>`;
        }
        return html + `</div></div>`;
    }
    function selectDate(d) { selectedDate = d; renderPage(); }
    function applyStamp(type) {
        const item = wikiData[currentPage-1]; if(!item.stamps) item.stamps = {};
        if(!item.stamps[selectedDate]) item.stamps[selectedDate] = {m:false, n:false};
        if(type==='m') item.stamps[selectedDate].m = true; if(type==='n') item.stamps[selectedDate].n = true;
        save(); renderPage();
    }
    function addMonth() { const item = wikiData[currentPage-1]; item.visibleMonths = (item.visibleMonths || 1) + 1; save(); renderPage(); }

    function updateSelector() {
        const sel = document.getElementById('novel-selector'); const ns = [...new Set(wikiData.map(d=>d.novel))].filter(n=>n && n!=="ê³µí†µ");
        sel.innerHTML = '<option value="all">ì „ì²´ í”„ë¡œì íŠ¸ ë³´ê¸°</option>'; ns.forEach(n=>sel.innerHTML+=`<option value="${n}" ${currentNovel===n?'selected':''}>${n}</option>`);
    }

    function createNewProject() {
        const name=prompt("ì†Œì„¤ ì œëª©:");
        if(name){
            categories.forEach((cat,idx) => {
                if(idx === 2) return; 
                const template = (idx === 0) ? analysisTemplate : "";
                wikiData.push({novel:name, type:idx, title:`${cat} ì´ˆê¸° í•­ëª©`, content:template, analysis:template, accessibility:"í•˜", stamps:{}, visibleMonths:1});
            });
            save(); updateSelector(); switchNovel(name);
        }
    }

    function addItem(t) { 
        const novelName = (t === 2) ? "ê³µí†µ" : (currentNovel === "all" ? "ê¸°ë³¸" : currentNovel);
        const template = (t === 0) ? analysisTemplate : "";
        wikiData.push({novel:novelName, type:t, title:"ìƒˆ í•­ëª©", content:template, analysis:template, danger:1, habitat:"", weakness:"", testimony:""}); 
        save(); renderSidebar(); goPage(wikiData.length);
    }
    
    function deleteEntireProject() { if(confirm('í”„ë¡œì íŠ¸ ì „ì²´ ì‚­ì œ?')){ wikiData=wikiData.filter(d=>d.novel!==currentNovel); save(); switchNovel("all"); } }
    function deleteItem() { if(confirm('ì‚­ì œ?')){ wikiData.splice(currentPage-1,1); save(); if(currentPage>wikiData.length) currentPage=1; renderPage(); renderSidebar(); } }
    
    // [ë²„ê·¸ ìˆ˜ì •] ë…ììš© ë§í¬ ìƒì„± ë¡œì§ ê³ ë„í™”
    function copyReaderLink() {
        const url = new URL(window.location.href);
        url.searchParams.set('mode', 'read');
        const readerUrl = url.toString();
        navigator.clipboard.writeText(readerUrl).then(() => {
            alert("ë…ììš© ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n" + readerUrl + "\n\n(ì£¼ì˜: ë°ì´í„°ê°€ í¬í•¨ëœ íŒŒì¼ì„ ë°°í¬í•´ì•¼ ë…ìê°€ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)");
        });
    }

    function copyFullSource() { navigator.clipboard.writeText(document.documentElement.outerHTML); alert("ì†ŒìŠ¤ ë³µì‚¬ ì™„ë£Œ!"); }
    function exportData() { const b=new Blob([JSON.stringify(wikiData)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`backup.json`; a.click(); }
    function toggleMemo() { document.getElementById('m-box').classList.toggle('active'); }
    function setTheme(c) { document.documentElement.style.setProperty('--accent',c); save(); }
    function toggleNarrativeTable() {
        const modal = document.getElementById('narrative-modal'); const body = document.getElementById('narrative-body');
        if (modal.style.display === 'flex') { modal.style.display = 'none'; return; }
        body.innerHTML = ""; wikiData.forEach(item => { if(item.actionLogs) item.actionLogs.forEach(l => { if(l.char||l.act) body.innerHTML += `<tr style="border-bottom:1px solid #eee;"><td style="padding:10px;">${categories[item.type]}</td><td style="padding:10px;"><b>${l.char}</b></td><td style="padding:10px;">${l.act}</td></tr>`; })});
        modal.style.display = 'flex';
    }
</script>


</body></html>
